---
layout: single
title:  "[유니티 그래픽스 최적화 스타트업 정리] 그림자"
author_profile: false
tag : [유니티 최적화]
categories : 유니티 최적화
typora-root-url: ../
---

> ## 개요

이 글은 "[유니티 그래픽스 최적화 스타트업](https://product.kyobobook.co.kr/detail/S000001888125)"이라는 책을 보고 정리한 글입니다.

게임에서 빠질 수 없는 요소 중 하나로 그림자가 있습니다.

게임에서 그림자는 유저에게 사물의 공간상 위치를 인지하기 쉽게 만들어 주고 게임의 입체감을 더해주는 중요한 그래픽 요소입니다. 오늘은 이러한 그림자에 대해 조사하고 정리했습니다.



> ## 그림자(Shadow)란?

어떤 사물에 의해서 빛이 차폐되는 현상을 말합니다. 빛이 사물에 닿으면 그 뒤쪽은 빛이 닿지 않습니다. 이 부분 즉, 빛이 닿지 않는 영역이 그림자 영역이 됩니다.

![image-20230712180202382](/images/2023-07-12-first/image-20230712180202382.png)



> ## 쉐도우맵(Shadow Map)이란?

유니티에서 제공하는 그림자는 쉐도우맵 기법을 사용하고 있습니다. 이 기법은 모든 굴곡에 대응하고 셀프-쉐도우(Self-Shadow)가 처리되는 등 높은 퀄리티를 보여줍니다.

쉐도우맵의 경우 그림자의 깊이를 저장하는 버퍼를 만든 후 프래그먼트 쉐이더에서 깊이를 비교하는 과정을 거칩니다. 또한 넓은 영역을 커버하기 위해 여러 구역으로 나누기(Cascade)도 하고 계단 현상을 없애기 위해 여러 번 샘플링하여 필터링 처리를 하는 등 부가 기능들이 추가됩니다. 하지만 이러한 작업들은 비용이 비싸기 때문에 성능에 부담을 줄 수 있습니다.

쉐도우맵의 성능을 이해하려면 먼저 쉐도우맵이 어떻게 처리되는지에 대한 원리를 살펴봐야 합니다.

아래 사진을 예시로 들겠습니다.

![image-20230712185140006](/images/2023-07-12-1_Shadow/image-20230712185140006.png)

<br>

##### 뎁스 텍스처(Depth Texture) 생성

먼저 첫번째로 뎁스 텍스처를 생성합니다. 이 텍스처는 씬에 렌더링 될 오브젝트들의 깊이 갚을 저장합니다. 즉 오브젝트들이 카메라로부터 얼마만큼 떨어져 있는지를 저장하는 것입니다. 이 텍스처의 값은 카메라와 가까울수록 검은색에 가까우며, 카메라와 멀수록 흰색에 가깝습니다.

![image-20230712185953116](/images/2023-07-12-1_Shadow/image-20230712185953116.png)

<br>

##### 그림자 처리를 위한 버퍼(쉐도우맵(Shadow Map)) 생성

뎁스 텍스처를 생성하고 렌더링 한 이후, 그림자 처리를 위한 별도의 버퍼를 생성해야 합니다. 이 버퍼를 쉐도우맵이라고 부릅니다. 쉐도우맵에는 광원에서 바라보는 오브젝트 픽셀들의 깊이 값이 저장됩니다. 뎁스 텍스처와 마찬가지로 광원과의 거리에 따라 검은색에서 흰색 사이의 값이 저장됩니다. 이 버퍼 안에 있는 픽셀들의 값을 채우기 위해 오브젝트를 한번 더 렌더링합니다.

![image-20230712190504591](/images/2023-07-12-1_Shadow/image-20230712190504591.png)

<br>

##### 그림자 영역 계산

뎁스 텍스처와 쉐도우맵이 완성되면 뎁스 텍스처의 정보와 쉐도우맵의 정보를 비교하여 그림자 영역을 계산합니다. 뎁스 텍스처에 있는 픽셀들을 순회하면서 광원으로부터의 거리로 변환해 비교하는 것입니다. 해당 픽셀이 빛이 닿지 않는지 즉, 그림자 영역인지를 판단하는데 그 방법은 쉐도우맵에 저장된 거리보다 멀리 있으면 어떤 오브젝트에 의해 가려진 픽셀이라 판단하는 것입니다.

<br>

##### 스크린 스페이스(Screen Space) 쉐도우맵 생성

그림자 영역을 계산한 것을 바탕으로 그림자 결과를 만들어냅니다. 유니티의 경우 화면에 보이는 공간을 기준으로 처리하고 쉐도우맵을 이용하여 그림자를 표현하는데 이를 스크린 스페이스 쉐도우맵이라 부릅니다

<br>

보시는 것처럼 유니티는 여러 단계를 거쳐서 그림자를 만들어냅니다. 그리고 이 과정은 간단한 과정이 아닙니다. 먼저 뎁스 텍스처와 쉐도우맵을 렌더링하기 위한 드로우콜이 필요하며, 화면에 보이는 모든 픽셀에 대해서 그림자 결과를 계산 및 비교하는 연산이 필요합니다. 또한 이러한 연산은 프래그먼트 쉐이더에서 이루어지기 때문에 결과적으로 그림자를 처리하는 것은 CPU와 GPU에 많은 부담을 줍니다. 그렇기 때문에 반드시 그림자가 적용되어야 하는 오브젝트만 그림자를 활성화 시키는 것이 중요합니다.



##### 캐스케이드 쉐도우맵(Cascade Shadow Maps)

멀리 떨어져 있는 오브젝트들도 실시간 그림자 처리를 할 필요가 있을 때 사용하면 좋은 기법입니다. LOD처럼 쉐도우맵을 여러 개 만들어 카메라와의 거리에 따라 퀄리티를 다르게 주는 방법으로 쉐도우맵의 경우 해상도를 다르게 줍니다. 높은 해상도를 사용하면 그만큼 시각적인 퀄리티가 올라가지만 그만큼 메모리를 많이 요구하며 연산도 더 많이 요구됩니다. 그렇기 때문에 가까이 있는 경우 높은 해상도를 가진 쉐도우맵을 사용하고 멀리 떨어질수록 낮은 해상도를 가진 쉐도우맵을 사용해 최적화시키는 것입니다.



> ## 평면 그림자

유니티에서 사용하는 쉐도우맵은 렌더링 비용을 많이 차지하는 요소입니다. 최적화를 잘하면 좋은 성능을 낼 수 있지만, 게임의 지형이 평면인 경우 좀 더 저렴하게 표현할 수 있는 평면 그림자를 사용할 수 있습니다. 주로 저사양 모바일 디바이스를 타겟으로 하는 게임에서 많이 사용하는데, 그림자를 원으로 간단하게 표현하는 방법입니다. 즉, 아래 사진처럼 원형의 텍스처를 사용해 캐릭터 아래에 배치하는 것입니다.

<img src="/images/2023-07-12-first/images.jpg" alt="images" style="zoom:200%;" />

구현도 간단하며 연산 비용도 많이 들지 않습니다. 하지만 지형 바닥이 평면이 아니라면표현할 수 없다는 단점이 있지만 현재 많은 모바일 게임이 평면에서 진행되고, 탑 뷰 등 카메라가 고정되어 있으므로 이 방식이 널리 쓰이고 있습니다.



> ## 메시 평면 그림자([ozlael-PlannarShadowForUnity 참고](https://github.com/ozlael/PlannarShadowForUnity))

메시 평면 그림자는 제약이 많은 구식 기법이지만, 저렴한 성능 때문에 모바일 게임에 적합한 그림자 표현 기법입니다. 이 그림자는 진짜 그림자는 아닙니다. 단지 한 번 더 렌더링 되는 메시일 뿐입니다. 버텍스 쉐이더를 이용해서 메시가 바닥면으로 투영되도록 조작함으로써 그림자처럼 보이게 계산합니다. 그렇기 떄문에 비싼 연산을 거치지 않게 됩니다.

메시 평면 그림자 기법으로 그림자를 표현하면 아래 사진처럼 각이 있는 하드 엣지 형태의 그림자가 그려집니다.

![image-20230712102204131](/images/2023-07-12-first/image-20230712102204131.png)



##### 메시 평면 그림자 연산의 원리

![image-20230712101851986](/images/2023-07-12-first/image-20230712101851986.png)

위의 사진처럼 어느 한 점에 P가 있고 광원 방향이 L이라고 했을 때, 평면에 점P가 투영되는 위치는 점P1입니다. 점P와 점P1을 잇는 선을 H라 하고, 점P를 평면과 수직으로 잇는 선을 O라고 하겠습니다. 선분 H와 O의 각을 θ라고 했을 때 cosθ는 L과 Normalized O 의 내적입니다(L은 이미 단위화 되어 있음). 이미 O는 평면과 수직인 상태이므로 최종적으로 cosθ와 L.y는 동일합니다. 그러면 아래 그림 같이 빗변을 L, 맞변을 L.y로 삼는 빨간 삼각형을 이룰 수 있ㅅ브니다.

삼각비에 의해서 L:L.y = H:O가 되고 L은 단위화 되어 길이가 1이므로 H = O/L.y 가 됩니다. 즉, P1 = P + L * (O/L.y) 입니다.

이처럼 간단한 수식에 의해 그림자 메시의 버텍스들을 빛의 방향으로 평면에 투영시키듯이 위치를 옮겨주는 것입니다. 지형의 바닥이 평면인 경우 비교적 좋은 퀄리티의 그림자를 저렴한 연산으로 처리할 수 있습니다. 하지만 셀프 쉐도우가 처리되지 않는다는 단점이 있습니다. 
