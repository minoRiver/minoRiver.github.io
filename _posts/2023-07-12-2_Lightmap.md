---
layout: single
title:  "[유니티 그래픽스 최적화 스타트업 정리] 라이트맵"
author_profile: false
tag : [유니티 최적화]
categories : 유니티 최적화
typora-root-url: ../

---

> ## 개요

이 글은 "[유니티 그래픽스 최적화 스타트업](https://product.kyobobook.co.kr/detail/S000001888125)"이라는 책을 보고 정리한 글입니다.

오늘은 라이트 최적화 방법 중 하나인 라이트맵에 대해서 조사하고 정리했습니다.

글 작성 당시 유니티 버전은 2021.3.21f1 버전이며 URP(12.1.10)를 사용했습니다.



> ## 라이트맵(Lightmap)란?

라이트맵은 GI 및 그림자 등을 포함한 라이팅 정보를 미리 연산하여 텍스처로 저장하는 기능을 의미합니다. 말 그대로 라이팅 정보를 담는 텍스처입니다. 라이트맵 텍스처는 라이팅 관련 정보가 담깁니다.

<br>

아래 사진처럼 씬에 큐브 주변으로 4개의 포인트 라이트를 배치하고 라이트맵을 적용시켰습니다.

![image-20230712153805213](images/2023-07-12-two/image-20230712153805213.png)

![image-20230712153725514](images/2023-07-12-two/image-20230712153725514.png)

<br>

적용시킨 결과 라이트맵 텍스처가 아래 사진처럼 생성되는 것을 확인할 수 있습니다.

![image-20230712153700618](images/2023-07-12-two/image-20230712153700618.png)



> ## 라이트맵을 만드는 과정

라이트맵을 사용하려면 먼저 유니티 에디터에서 씬에 라이트들을 배치하고 사전에 미리 연산하여 라이트맵을 만들어야 합니다. 라이트맵을 만드는 과정을 일반적으로 굽는다(Bake)라고 표현합니다. 그리고 완성된 라이트맵 텍스처는 Baked Lightmap 이라고 부릅니다.

라이트맵은 구워지고 난 이후에 게임이 수행되는 동안 기록된 라이팅 정보가 변경되지 않습니다. 그렇기 때문에 배경 오브젝트 같은 정적인 오브젝트에만 적용이 가능합니다.



##### 오브젝트의 플래그 설정

정적인 오브젝트, 즉 Static 플래그가 체크된 오브젝트는 라이트맵을 구울 때 미리 빛 연산이 저장됩니다.

![image-20230712154647572](images/2023-07-12-two/image-20230712154647572.png)

<br>

##### Baked 라이트 설치

오브젝트의 플래그만 켜준다고 해서 라이트맵이 생성되지 않습니다. 미리 연산될 라이트들의 타입을 Baked 모드로 바꿔줘야 합니다.

![image-20230712155018053](images/2023-07-12-two/image-20230712155018053.png)

위의 사진처럼 Baked 모드로 변경하면 라이트맵에 영향을 주는 라이트로 설정됩니다.



##### 라이트맵 굽기

오브젝트와 라이트의 설정이 모두 끝났다면 라이트맵을 구워주면 됩니다. 라이트맵을 구워주면 초반부의 사진과 같은 라이트맵 텍스처가 생성되며 그 외에 라이팅 정보와 관련된 여러 가지 에셋들이 생성됩니다.



이러한 과정은 게임이 실행되는 런타임 이전에 거치는 것이므로 라이트맵에 영향을 줄 라이트와 영향을 받을 오브젝트들은 런타임 이전에 씬에 존재해야 합니다. 즉, 런타임에 생성되는 오브젝트는 적용이 불가능합니다. 그래서 배경 오브젝트처럼 정적인 오브젝트에 사용하기 좋습니다.



> ## 라이트맵을 사용하는 이유

이러한 번거로운 과정을 거치면서 라이트맵을 사용하는 이유는 무엇일까요? 그 이유는 정적 오브젝트들은 런타임에 움직이지 않는다는 것에 있습니다. 런타임에 움직이지 않기 때문에 매번 라이팅 연산을 할 필요가 없습니다. 그렇기 때문에 라이트맵으로 런타임 이전에 연산을 진행하고 연산이 적용된 결과를 텍스처의 형태로 오브젝트에 적용하면 성능을 아낄 수 있습니다.

이러한 이유로 정적 오브젝트라면 라이트맵을 적용시키는 것이 런타임에 성능을 아낄 수 있어 좋습니다.



> ## 라이트맵의 해상도

Lightmap Resolution, Lightmap Padding, Lightmap Size 같은 라이트맵 텍스처의 해상도 및 텍스처 개수와 연관된 설정 값들이 있습니다.

Lightmap Resolution은 라이트맵 텍셀 밀도를 나타내는 수치입니다. 1 유닛 당 라이트맵의 해당 텍셀을 결정하는 수치로 이 숫자가 높을수록 라이트맵의 필요 해상도가 커집니다.

Lightmap Size는 라이트맵 텍스처의 해상도입니다. 만약에 필요한 총 해상도가 Lightmap Size보다 크면 여러 장의 라이트맵으로 나뉘게 됩니다. 라이트맵이 여러 개로 나뉘면 배칭이 깨질 확률이 높아집니다. 그 이유는 배칭은 같은 머티리얼을 사용하는 여러 오브젝트들의 메시를 합쳐서 한 번에 처리하는 것이기 때문입니다. 하지만 텍스처가 여러 개로 나뉜다면 다른 머티리얼이 되기 때문에 라이트맵을 생헝할 때 설정 값을 조절하여 1개로 만드는 것이 좋습니다.



> ## Directional Mode

라이트맵이 적용되는 오브젝트에 노멀맵이 적용되도록 하고 싶은 경우 Directional Mode를 Directional로 설정하면 됩니다.

![image-20230712160913993](images/2023-07-12-two/image-20230712160913993.png)

하지만 그만큼 더 추가적인 리소스와 성능이 필요합니다. 만약 Non-Directional 모드라면 라이팅과 그림자 등이 기록된 라이트맵만 사용하며, 노멀맵, 스페큘러 하이라이트 같은 처리를 하지 않습니다. 단 리플렉션 프로브는 적용됩니다.
