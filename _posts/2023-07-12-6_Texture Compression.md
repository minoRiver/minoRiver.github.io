---
layout: single
title:  "[유니티 그래픽스 최적화 스타트업 정리] 텍스처 최적화(텍스처 압축)"
author_profile: false
tag : [유니티 최적화]
categories : 유니티 최적화
typora-root-url: ../
---

> ## 개요

이 글은 "[유니티 그래픽스 최적화 스타트업](https://product.kyobobook.co.kr/detail/S000001888125)"이라는 책을 보고 정리한 글입니다.

오늘은 텍스처 최적화 기술 중 하나인 텍스처 압축에 대해 조사하고 정리했습니다.



> ## 텍스처 압축이란?

디스크의 용량과 메모리의 크기 모두를 절약할 수 있는 텍스처 최적화 기술 중 하나입니다. 텍스처는 근본적으로 수많은 비트(Bit) 데이터들로 이루어진 이미지 데이터입니다. 그래서 GPU가 이 데이터를 사용하려면 데이터 대역폭이 필요합니다. 즉 성능을 필요로 합니다. 그래서 컴퓨터가 렌더링을 할 때 사용하는 텍스처는 고정된 비율을 가진 '블럭 형태의 손실 압축 기법'을 사용합니다.



> ## 텍스처 이미지 정밀도 줄이기

텍스처의 사이즈를 줄이는 가장 쉬우면서도 간단한 방법은 텍스처 이미지의 정밀도, 즉 bpp를 줄이는 것입니다.

예시로 알파 채널 없이 RGB 채널만 사용하는 이미지를 사용한다고 가정할 때, 채널 당 8비트를 사용하는 244bpp 텍스처를 채널 당 4비트로 줄이면 12bpp가 되며 사이즈가 절반으로 줄어듭니다. 하지만 이렇게 되면 텍스처가 표현 가능한 컬러 범위도 절반이 넘게 줄어듭니다. 

|          bpp          |            24bpp            |        12bpp        |
| :-------------------: | :-------------------------: | :-----------------: |
| 표현 가능한 컬러 개수 | 16,777,216(256 * 256 * 256) | 4,096(16 * 16 * 16) |

위의 표에서도 알 수 있듯이 bpp를 절반으로 줄였지만 컬러 표현 범위는 4,096배가 차이나는 것을 알 수 있습니다. 이 때문에 마하 밴드가 생기는 등 시각적인 두드러짐 발생이 심해질 수 있습니다. 물론 성능은 올라가겠지만 시각적인 품질 저하에 많은 영향을 끼치면서 성능을 올리는 것은 원하는 결과가 아닐 가능성이 높습니다.

아래의 사진처럼 각 색 영역의 경계가 생기는 마하 밴드 효과라고 합니다.

![Bandes_de_mach](/images/2023-07-12-sixth/Bandes_de_mach.png)



> ## 이미지 파일 압축 포맷

보통 이미지를 저장할 때 압축을 통해 사이즈를 줄여서 저장합니다. 우선 흔히 아는 이미지 포맷의 경우 JPG, PNG 등의 포맷일 것입니다. 이러한 포맷들은 데이터 사이즈를 줄여서 디스크 용량을 절약하기 위해 고안되었습니다.

이러한 이미지 압축은 크게 손실 압축과 비손실 압축의 두 종류로 나뉩니다. 비손실 압축의 경우 원본 이미지를 그대로 유지하면서 데이터만 압축하는 방식으로 PNG가 대표적인 예입니다. 그리고 손실 압축은 원본 이미지의 퀄리티를 어느 정도는 훼손하는 대신에 데이터 압축 비율을 높여서 데이터 크기 절약에 집중하는 방식입니다. 대표적으로 JPG가 있습니다.

PNG나 JPG 포맷의 이미지들은 GPU가 읽어 들일 때 압축이 풀린 상태로 메모리에 올라갑니다. 그 이유는 GPU가 바로 읽어들일 수 없기 때문입니다. 왜냐하면, 이러한 포맷들은 파일 사이즈를 줄여서 디스크 용량 및 전송 대역폭을 절약하는 것에 초점이 맞춰져 있으며, GPU가 텍스처로 사용하는 데 초점이 맞춰져 있는 포맷이 아니기 때문입니다. 그래서 게임 같은 실시간 렌더링 방식에서는 특수한 텍스처 압축 포맷을 사용합니다. 유니티의 경우에도 텍스처의 확장자가 JPG인지 PNG인지 상관없이 특정 포맷의 이미지로 변환한 뒤 사용하며, Import 세팅에서 포맷, 그리고 그와 관련된 파라미터 값을 설정해줄 수 있습니다.



> ## 텍스처 압축의 조건

게임에서 사용하는 텍스처 압축 포맷들은 아래와 같은 사항들을 만족해야 합니다.

- 인코딩이 되어 있는 채로 메모리에 존재해야 합니다.
- 랜덤 액세스가 가능해야 합니다(이유에 대해서는 아래의 글에서 설명하겠습니다).
- 디코딩 속도가 빨라야 합니다.

이 외에도 압축의 디코딩 기능은 하드웨어에 구현되어 있기 대문에 텍스처 압축 포맷은 하드웨어에 의존적일 수밖에 없습니다. 그러므로 하드웨어에서 압축 포맷을 지원하는지 여부도 생각해야 합니다.

<br>



> ## 랜덤 액세스

텍스처 압축의 조건 중 하나로 "랜덤 액세스가 가능해야 한다"는 조건이 있었습니다. 그 이유는 첫 번째로 텍스처는 메시의 표면에 매핑되어 보이는 것이 주 목적이라는 이유가 있습니다. 메시의 표면에 텍스처가 매핑되려면 uv 혹은 st 라 불리는 텍셀 좌표가 필요합니다. 간단하게 말하면 현재 그려지는 픽셀에 대응하는 텍스처가 어느 지점에 있는지에 대한 정보가 필요하다는 것입니다. 또한 텍스처의 필터링 타입에 따라 여러 개의 텍셀을 한 번에 읽어 들여야 할 수도 있습니다. 이러한 상황에서 랜덤 액세스가 불가능하다면 텍스처의 특정 텍셀을 읽어올 때 연산량이 많아지게 됩니다. 이는 실시간으로 렌더링하는 게임에서 치명적인 성능 저하로 이어질 수 있습니다.

이러한 이유로 텍스처 압축의 조건 중 하나로 랜덤 액세스가 가능해야 한다는 조건이 있는 것입니다.



> ## 가변 비율 인코딩과 고정 비율 인코딩

위의 글에서 JPG나 PNG 포맷이 GPU에서 바로 읽어들일 수 없다고 했는데 이는 랜덤 액세스를 할 수 없다는 의미입니다. 그 이유는 이러한 포맷들은 가변 비율 인코딩 방식이기 때문입니다. 즉 압축의 비율이 원본 데이터에 따라서 달라진다는 것입니다. 그렇기 때문에 JPG, PNG 같은 포맷의 텍스처가 GPU 메모리에 올라갈 때 압축을 푼 상태로 올라가는 것입니다. 그 이유는 압축을 풀지 않은 상태로 올릴 경우 압축 비율이 텍스처마다 다르기 때문에 메시의 렌더링 될 픽셀에 대응되는 텍셀을 찾을 수 없기 때문입니다.

이러한 이유로 게임에서 사용하는 텍스처 압축 포맷은 고정 비율 인코딩 방식을 사용합니다. 즉, 고정 비율의 압축률을 가집니다. 이러한 방식은 특정 텍셀을 읽고 싶을 때 어느 위치의 데이터인지 충분히 예측 가능하기 때문에 랜덤 액세스가 가능합니다. 그래서 텍스처 인코딩은 주로 블록 단위로 이루어지며, 텍스처를 인코딩할 때 일정 크기의 블록 단위로 나눈 다음에 인코딩 작업을 진행합니다. 모바일의 경우 대표적으로 PVRTC, ETC, ASTC 포맷을 사용합니다.



> ## POT(Pow of Two) 텍스처

게임에서 사용하는 텍스처 압축은 블록 기반이기 때문에 해상도에 제약이 있습니다. ETC나 PVRTC 포맷의 경우 2의 n승의 해상도로 제작되어야 합니다.

이러한 해상도의 텍스처를 POT 텍스처라 부르며, POT가 아닌 텍스처를 NPOT(Not-POT) 텍스처라 부릅니다. 만약 ETC나 PVRTC 포맷을 사용하는 텍스처가 POT 텍스처가 아닌 경우 유니티에서 경고 메시지가 나옵니다. 만약 NPOT 텍스처들을 사용하고 싶다면 아틀라스로 묶어 해결할 수 있습니다.
