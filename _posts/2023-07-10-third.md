---
layout: single
title:  "[유니티 그래픽스 최적화 스타트업 정리] 병목"
author_profile: false
tag : [유니티 최적화]
categories : 유니티 최적화
typora-root-url: ../
---

> ## 개요

이 글은 "[유니티 그래픽스 최적화 스타트업](https://product.kyobobook.co.kr/detail/S000001888125)"이라는 책을 보고 정리한 글입니다.

최적화는 주어진 상황에서 가장 알맞은 결과를 얻을 수 있도록 처리하는 과정입니다. 소프트웨어의 경우 CPU 및 GPU 연산 비중을 낮추고, 메모리의 사용도 낮추고, 전력 소모량을 줄여 소트프웨어가 원활하게 구동시키는 과정이라고 말할 수 있습니다.

게임에서 성능 최적화를 위해 해야할 것들은 다양합니다. 예를 들어, 메시의 버텍스를 줄인다거나 쉐이더 최적화, 게임 로직 최적화 등등 다양합니다. 그렇다면 이러한 것들을 무작정 최적화하는 것이 좋을까요? 그 대답은 아니라고 할 수 있습니다. 최적화를 하는 것은 물론 중요하지만 최적화를 하기 전에 먼저 병목 지점을 찾고 병목의 원인을 해결하기 위한 최적화 작업을 수행하는 것이 올바른 최적화 방법이라고 말할 수 있습니다.



> ## 병목(Bottleneck)이란?

일반적으로 페트병의 입구를 병목이라고 합니다. 페트병 중에 물병을 예시로 들자면, 물병의 입구를 보면 입구가 좁게 만들어져 있어 흐르는 속도에 제한을 받습니다. 그래서 물병 안의 공간이 크더라도 작은 병목을 통하면 적은 양의 물이 나옵니다.

이러한 현상에 빗대어 전체 프로세스가 갑자기 느려지거나 막혀서 정지하는 원인 혹은 장소를 병목이라고 부릅니다. 또한 전체 시스템의 성능이나 용량이 병목으로 인해 제한받는 현상이 발생하면 병목 현상이 발생했다고 말합니다.

병목 현상은 주로 교통 분야에서 언급됩니다. 고속도로에서 사고가 발생해 도로가 좁아지는 경우 교통 체증이 발생하게 됩니다. 혹은 주차장에서 많은 차들이 빠져나오려고 할 때 출구가 하나밖에 없다면 마찬가지로 교통 체증이 발생하게 됩니다. 이러한 현상을 네트워크 속도에 적용하게 되면 사용자가 제공받는 인터넷 서비스가 있다고 가정했을 때, 인터넷 서비스 속도가 아무리 빠르더라도 WiFi 공유기 속도가 느리다면 결국 사용자의 기기에서는 WiFi 속도밖에 사용할 수 없습니다. 이 경우 WiFi 공유기가 병목 현상의 원인이 된다고 말합니다.



> ## 최적화 방향 결정

게임 개발을 하기 전에 먼저 주 타깃 기기를 결정하는 것이 중요합니다. 그 이유는 출시하려는 게임의 타겟층에 따라 주 타깃 기기가 달라질 것이며 정해진 타깃 기기가 무엇이냐에 따라 하드웨어 스펙이 제각각이기 때문입니다. 예를 들어 캐주얼 게임이라면 남녀노소 누구나 쉽게 즐길 수 있어야 하기 때문에 저사양 보급형 기기에서도 원활하게 플레이가 되야 합니다. 그렇다면 주 타깃 기기는 저사양 보급형 기기가 될 것이며 최적화의 방향 또한 그 기기 환경 내에서 최대의 성능을 끌어올리는 것이 될 것입니다.

이러한 이유들로 최적화의 방향을 정하기 전에 최적화를 진행할 환경을 알기 위해 주 타깃 기기를 결정하는 것은 매우 중요합니다.



> ## 성능의 척도 FPS vs Frame Time

보편적이고 손쉽게 성능을 측정하는 방법 중 하나는 FPS를 체크하는 것입니다. 현재 FPS 측정 값으로 성능이 잘 나오는지 체크하는 것입니다. 하지만 프로파일링 등 정밀하게 게임의 성능을 측정할 때는 FPS보단 프레임 타임 즉, 한 프레임을 처리하는데 걸리는 시간으로 측정하는 것이 좋습니다.

그 이유는 프레임 타임은 구간 측정과 선형 측정이 가능한데 FPS는 불가능하기 때문입니다.

먼저 구간 측정의 경우 FPS는 Frame Per Second 즉 1초에 몇 프레임을 처리했는지입니다. 이 수치는 전체 프레임 처리에 대한 결과는 알 수 있지만 특정 구간만 확인하는 것은 안됩니다. 하지만 프레임 타임은 시간이기 때문에 특정 구간의 로직을 처리했을 때 걸리는 시간을 체크할 수 있습니다.

그리고 선형 측정의 경우는 예시로 설명하겠습니다. 오브젝트 1개를 추가했을 때 연산량이 11.1ms 가 발생하며 오브젝트가 몇개가 추가되든 1개의 연산량은 변화가 없다고 가정했을 때, 성능에 변화에 따라 FPS와 프레임 타임의 결과를 표로 나타내면 아래와 같습니다.

| 성능                 | FPS      | Frame Time |
| -------------------- | -------- | ---------- |
| 오브젝트 1개(11.1ms) | 90.0 FPS | 11.1ms     |
| 오브젝트 2개(22.2ms) | 45.0 FPS | 22.2ms     |
| 오브젝트 3개(33.3ms) | 30.0 FPS | 33.3ms     |
| 오브젝트 4개(44.4ms) | 22.5 FPS | 44.4ms     |
| 오브젝트 5개(55.5ms) | 18.0 FPS | 55.5ms     |

표를 보시면 알 수 있듯이 FPS는 비선형적으로 증감하고 있는데 비해 프레임 타임은 선형적으로 증감합니다.

이러한 이유로 성능을 측정할 때는 FPS보다 프레임 타임을 사용하는 것이 변화량을 제대로 측정할 수 있습니다. 또한 측정 시 한 번 측정하고 끝내는 것이 아니라 여러 번 측정한 후 평균값을 데이터로 삼는 것이 좋습니다. 매번 측정할 때마다 값이 다를 수 있기 때문입니다. 또한 여러 케이스에서 다양하게 측정하는 것이 좋습니다. 그 이유는 특정 케이스마다 병목의 원인이 달라질 수 있기 때문입니다.



> ## 쓰로틀링을 고려한 성능 측정

모바일 환경에서 프로파일링 시 쓰로틀링 상태로 진입하게 되면 결과에 신뢰도가 확 떨어집니다. 그 이유는 쓰로틀링 상태에 진입하게 되면 기기의 성능 저하가 발생하기 때문에 뜻하지 않는 결과가 발생할 수 있기 때문입니다. 그렇기 때문에 모바일 환경에서 프로파일링을 진행할 때는 쓰로틀링을 고려하면서 측정을 해야 합니다.

먼저 타깃 기기가 쓰로틀링 상태로 얼마나 빠르게 진입하는지 체크해야 합니다. 또한 쓰로틀링이 여러 단계에 걸쳐 발생한다면 단계마다 발생하는 성능 하락에 대해서도 파악해야 합니다. 그래야 쓰로틀링으로 인한 병목인지 혹은 연산이 많아져 실제 발생하는 병목인지 파악하기 쉬워지기 때문입니다. 그리고 최대한 노트북, 데스크톱 같은 열기가 발생할 수 있는 것들로부터 떨어뜨려놓은 상태에서 측정을 진행해야 합니다. 또한 스마트폰 발열 방지를 위해 스마트폰 전용 쿨링펜이나 아이스팩 등을 사용할 수도 있습니다. 마지막으로 충전 중에는 온도가 더 높아질 수 있기 때문에 항상 기기가 100% 충전된 상태에서 측정해야 하며 열을 식힌 상태에서 시작하는 것이 좋기 때문에 측정 후 다음 측정까지 쿨타임을 가지고 진행하는 것이 좋습니다.
